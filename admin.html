
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>لوحة الأدمن - إضافة عنوان</title>
  <style>
    :root{
      --bg:#0f0c29; --card:rgba(255,255,255,0.08);
      --border:rgba(255,255,255,0.12); --text:#fff;
      --p:#6c5ce7; --s:#a29bfe; --ok:#25D366; --danger:#ff4d4d;
    }
    *{box-sizing:border-box;font-family:Segoe UI,Tahoma,Arial}
    body{margin:0;background:radial-gradient(circle at top,#1e1b4b,var(--bg),#050505);color:var(--text)}
    .wrap{max-width:980px;margin:0 auto;padding:18px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:10px 0 18px}
    .brand{font-weight:800;letter-spacing:.3px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:16px;backdrop-filter:blur(12px)}
    .grid2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    @media(max-width:780px){.grid2{grid-template-columns:1fr}}
    .btn{
      width:100%;padding:14px;border:0;border-radius:14px;cursor:pointer;
      font-weight:800;color:#fff;background:rgba(255,255,255,0.10);
      border:1px solid rgba(255,255,255,0.18); transition:.2s; text-align:center;
    }
    .btn:hover{transform:translateY(-2px);border-color:var(--s)}
    .btn.primary{background:linear-gradient(135deg,var(--p),var(--s));border:0}
    .btn.ok{background:var(--ok);border:0}
    .btn.danger{background:rgba(255,77,77,0.15);border:1px solid rgba(255,77,77,0.35)}
    
    input, textarea, select{
      width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.14);
      background:rgba(0,0,0,0.25); color:#fff; outline:none; margin-bottom: 5px;
    }
    textarea{min-height:100px;resize:vertical}
    label{display:block;margin:12px 0 6px;font-weight:700; color:var(--s); font-size:0.9rem}
    .hidden{display:none !important}
    .hr{height:1px;background:rgba(255,255,255,0.10);margin:14px 0}
    
    /* تنسيق الصورة 16:9 */
    .img-upload-box {
        width: 100%;
        position: relative;
        aspect-ratio: 16/9; 
        background: rgba(255,255,255,0.05);
        border: 2px dashed rgba(255,255,255,0.2);
        border-radius: 14px;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        margin-bottom: 15px;
    }
    .img-upload-box:hover { border-color: var(--p); }
    .img-upload-box img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        position: absolute;
        top: 0; left: 0;
    }
    .img-upload-box input {
        position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 2;
    }
    .placeholder-text { pointer-events: none; color: rgba(255,255,255,0.5); }

    /* تنسيق الحقول المزدوجة */
    .link-group {
        background: rgba(0,0,0,0.2);
        padding: 10px;
        border-radius: 12px;
        border: 1px solid rgba(255,255,255,0.05);
        margin-bottom: 10px;
    }
    .link-group label { margin-top: 0; font-size: 0.8rem; color: #ccc; }

    .list{display:grid;gap:10px}
    .item{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:rgba(255,255,255,0.10);font-size:.75rem}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <div class="brand">لوحة الأدمن</div>
        <div class="muted" style="font-size: 0.8rem; opacity: 0.7;">تجهيز الأعمال - مع العنوان</div>
      </div>
      <button id="logoutBtn" class="btn danger hidden" style="max-width:120px; padding: 10px;">خروج</button>
    </div>

    <div id="loginCard" class="card">
      <h3 style="margin:0 0 10px;color:var(--s)">دخول الإدارة</h3>
      <label>كلمة السر</label>
      <input id="password" type="password" placeholder="••••••••"/>
      <button id="loginBtn" class="btn primary" style="margin-top:15px">دخول</button>
      <div id="loginMsg" style="margin-top:10px;color:var(--danger); font-size:0.8rem"></div>
    </div>

    <div id="panel" class="card hidden">
      <div class="grid2">
        <button id="openAdd" class="btn ok">إضافة عمل جديد</button>
        <button id="openList" class="btn">إدارة الأعمال</button>
      </div>

      <div id="addBox" class="hidden" style="margin-top:14px">
        <div class="hr"></div>

        <label>صورة الغلاف (قياس 16:9)</label>
        <div class="img-upload-box">
            <span class="placeholder-text">اضغط لرفع صورة</span>
            <img id="preview" class="hidden"/>
            <input id="imgInput" type="file" accept="image/*"/>
        </div>

        <label>عنوان العمل</label>
        <input id="workTitle" type="text" placeholder="مثلاً: تصميم موقع إلكتروني متكامل" />

        <div class="link-group">
            <label>بيانات الزر الأول (الأساسي)</label>
            <div class="grid2" style="gap:5px">
                <input id="btn1Name" type="text" placeholder="اسم الزر (مثلاً: معاينة)"/>
                <input id="btn1Link" type="url" placeholder="الرابط (https://...)"/>
            </div>
        </div>

        <div class="link-group">
            <label>بيانات الزر الثاني (الإضافي)</label>
            <div class="grid2" style="gap:5px">
                <input id="btn2Name" type="text" placeholder="اسم الزر (مثلاً: فيديو)"/>
                <input id="btn2Link" type="url" placeholder="الرابط (https://...)"/>
            </div>
        </div>

        <label>الوصف</label>
        <textarea id="description" placeholder="اكتب تفاصيل ووصف العمل هنا..."></textarea>

        <div class="grid2">
            <div>
                <label>التقييم</label>
                <select id="stars">
                  <option value="5">★★★★★ (5 نجوم)</option>
                  <option value="4">★★★★☆ (4 نجوم)</option>
                  <option value="3">★★★☆☆ (3 نجوم)</option>
                  <option value="2">★★☆☆☆ (2 نجوم)</option>
                  <option value="1">★☆☆☆☆ (1 نجمة)</option>
                </select>
            </div>
            <div>
                <label>السعر ($)</label>
                <input id="price" type="number" placeholder="0.00"/>
            </div>
        </div>

        <div style="height:12px"></div>
        <button id="saveBtn" class="btn primary">حفظ العمل ✅</button>
        <div id="saveMsg" style="margin-top:10px; font-size:0.9rem"></div>
      </div>

      <div id="listBox" class="hidden" style="margin-top:14px">
        <div class="hr"></div>
        <div id="list" class="list"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyArg6aPnPyd0x5C2HbZ8o5wpVmhmmSYS6Q",
      authDomain: "fn1998.firebaseapp.com",
      projectId: "fn1998",
      storageBucket: "fn1998.firebasestorage.app",
      messagingSenderId: "326727010464",
      appId: "1:326727010464:web:831654b2593ae59d5821c5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const MASTER_PASS = "BbZzAaMm";

    const loginCard = document.getElementById("loginCard"), panel = document.getElementById("panel"), logoutBtn = document.getElementById("logoutBtn");
    
    // العناصر
    const imgInput = document.getElementById("imgInput"), preview = document.getElementById("preview");
    const titleEl = document.getElementById("workTitle"); // تم اضافة العنوان
    const btn1NameEl = document.getElementById("btn1Name"), btn1LinkEl = document.getElementById("btn1Link");
    const btn2NameEl = document.getElementById("btn2Name"), btn2LinkEl = document.getElementById("btn2Link");
    const descEl = document.getElementById("description");
    const starsEl = document.getElementById("stars");
    const priceEl = document.getElementById("price");
    
    const saveBtn = document.getElementById("saveBtn"), saveMsg = document.getElementById("saveMsg");

    let imageDataURL = ""; 

    const compressImage = (file, quality = 0.3, maxWidth = 800) => {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = event => {
          const img = new Image();
          img.src = event.target.result;
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;
            if (width > height) {
              if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
            } else {
              if (height > maxWidth) { width *= maxWidth / height; height = maxWidth; }
            }
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            resolve(canvas.toDataURL('image/jpeg', quality));
          };
        };
      });
    };

    function checkAuthStatus() {
      if(sessionStorage.getItem("isAdmin") === "true") {
        loginCard.classList.add("hidden");
        panel.classList.remove("hidden");
        logoutBtn.classList.remove("hidden");
        showAdd();
      } else {
        panel.classList.add("hidden");
        loginCard.classList.remove("hidden");
        logoutBtn.classList.add("hidden");
      }
    }

    document.getElementById("loginBtn").onclick = () => {
      const pass = document.getElementById("password").value;
      if(pass === MASTER_PASS) {
        sessionStorage.setItem("isAdmin", "true");
        checkAuthStatus();
      } else {
        document.getElementById("loginMsg").textContent = "كلمة السر غير صحيحة!";
      }
    };

    logoutBtn.onclick = () => {
      sessionStorage.removeItem("isAdmin");
      location.reload();
    };

    checkAuthStatus();

    document.getElementById("openAdd").onclick = showAdd;
    document.getElementById("openList").onclick = showList;
    function showAdd() { addBox.classList.remove("hidden"); listBox.classList.add("hidden"); }
    function showList() { listBox.classList.remove("hidden"); addBox.classList.add("hidden"); loadList(); }

    imgInput.onchange = async e => {
      const file = e.target.files[0];
      if(!file) return;
      imageDataURL = await compressImage(file, 0.4, 800);
      preview.src = imageDataURL;
      preview.classList.remove("hidden");
      document.querySelector('.placeholder-text').style.display = 'none';
    };

    saveBtn.onclick = async () => {
      // التحقق من العنوان والصورة
      if(!imageDataURL || !titleEl.value) return alert("يرجى رفع الصورة وكتابة عنوان العمل");
      saveMsg.textContent = "جاري الحفظ...";

      try {
        await addDoc(collection(db, "projects"), {
          title: titleEl.value.trim(), // حفظ العنوان
          
          btn1_name: btn1NameEl.value.trim(),
          btn1_url: btn1LinkEl.value.trim(),
          
          btn2_name: btn2NameEl.value.trim(),
          btn2_url: btn2LinkEl.value.trim(),
          
          description: descEl.value.trim(),
          price: priceEl.value || "0",
          stars: parseInt(starsEl.value),
          
          imageData: imageDataURL,
          createdAt: serverTimestamp()
        });
        alert("تم الحفظ بنجاح! ✅");
        location.reload();
      } catch(e) { saveMsg.textContent = "خطأ: " + e.message; }
    };

    async function loadList() {
      const listEl = document.getElementById("list");
      listEl.innerHTML = "جاري التحميل...";
      const snap = await getDocs(query(collection(db, "projects"), orderBy("createdAt", "desc")));
      listEl.innerHTML = "";
      snap.forEach(d => {
        const r = d.data();
        const div = document.createElement("div");
        div.className = "card"; div.style.marginBottom = "10px";
        div.innerHTML = `
          <div class="item">
            <img src="${r.imageData}" style="width:80px; aspect-ratio:16/9; border-radius:8px; object-fit:cover">
            <div style="flex:1; margin-right:10px">
              <div style="font-weight:bold">${r.title}</div>
              <div style="font-size:0.8rem; opacity:0.7">${r.price}$ - ${r.stars}★</div>
            </div>
            <button class="btn danger" style="width:70px; padding:5px">حذف</button>
          </div>`;
        div.querySelector(".danger").onclick = async () => {
          if(confirm("حذف هذا العمل نهائياً؟")){ await deleteDoc(doc(db, "projects", d.id)); loadList(); }
        };
        listEl.appendChild(div);
      });
    }
  </script>
</body>
</html>
